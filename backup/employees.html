<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee App - List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Employee App</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="/employees">Employees</a></li>
          <li class="nav-item"><a class="nav-link" href="/add">Add</a></li>
          <li class="nav-item"><a class="nav-link" href="/edit">Edit</a></li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item" id="loginLi"><a class="nav-link" href="/login">Login</a></li>
          <li class="nav-item" id="logoutLi" style="display:none;"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
          <li class="nav-item" id="roleDisplay" style="display:none;"><span class="navbar-text">Role: <span id="roleText"></span></span></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <h1 class="text-center mb-4">Employee List</h1>
        <form id="searchForm" class="mb-4">
          <div class="input-group">
            <input id="searchInput" placeholder="Search name or email..." class="form-control">
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="button" class="btn btn-outline-secondary" onclick="loadEmployees(1, '')">Clear</button>
          </div>
        </form>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark"><tr><th>ID</th><th>Name</th><th>Email</th><th>Department</th><th>Actions</th></tr></thead>
            <tbody id="employeeTable"><tr><td colspan="5" class="text-center">Loading...</td></tr></tbody>
          </table>
        </div>
        <nav aria-label="Pagination">
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = '/api';
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    if (!token) { window.location.href = '/login';}
    document.getElementById('loginLi').style.display = 'none';
    document.getElementById('logoutLi').style.display = 'list-item';
    document.getElementById('roleDisplay').style.display = 'list-item';
    document.getElementById('roleText').textContent = role.charAt(0).toUpperCase() + role.slice(1);
    let currentPage = 1;
    let currentSearch = '';
    function logout() { localStorage.clear(); window.location.href = '/login'; }
    async function loadEmployees(page = 1, search = '') {
      currentPage = page; currentSearch = search;
      const tbody = document.getElementById('employeeTable');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border"></div> Loading...</td></tr>';
      const res = await fetch(`${API_BASE}/employees?page=${page}&search=${search}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.status === 401) { localStorage.clear(); window.location.href = '/login'; return; }
      const { employees, totalPages } = await res.json();
      tbody.innerHTML = '';
      if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No employees found.</td></tr>';
      } else {
        employees.forEach(emp => {
          tbody.innerHTML += `<tr>
            <td>${emp._id.slice(-6)}</td>
            <td>${emp.name}</td>
            <td>${emp.email}</td>
            <td>${emp.department}</td>
            <td>
              <a href="/details?id=${emp._id}" class="btn btn-sm btn-info me-1">Details</a>
              <a href="/edit?id=${emp._id}" class="btn btn-sm btn-primary me-1">Edit</a>
              <button onclick="deleteEmp('${emp._id}')" class="btn btn-sm btn-danger">Delete</button>
            </td>
          </tr>`;
        });
      }
      // Pagination
      let pagHtml = '<ul class="pagination">';
      if (page > 1) pagHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmployees(${page-1}, '${search}')">Previous</a></li>`;
      for (let i = 1; i <= totalPages; i++) {
        pagHtml += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadEmployees(${i}, '${search}')">${i}</a></li>`;
      }
      if (page < totalPages) pagHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmployees(${page+1}, '${search}')">Next</a></li>`;
      pagHtml += '</ul>';
      document.getElementById('pagination').innerHTML = pagHtml;
    }
    async function deleteEmp(id) {
      if (!confirm('Delete this employee?')) return;
      const res = await fetch(`${API_BASE}/employees/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
      if (res.ok) { loadEmployees(currentPage, currentSearch); alert('Deleted!'); } else alert('Error deleting');
    }
    document.getElementById('searchForm').addEventListener('submit', (e) => {
      e.preventDefault();
      loadEmployees(1, document.getElementById('searchInput').value);
    });
    loadEmployees();
  </script>
</body>
</html>
