<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee App - Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Employee App</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/employees">Employees</a></li>
          <li class="nav-item"><a class="nav-link" href="/add">Add</a></li>
          <li class="nav-item"><a class="nav-link" href="/edit">Edit</a></li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item" id="loginLi"><a class="nav-link" href="/login">Login</a></li>
          <li class="nav-item" id="logoutLi" style="display:none;"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
          <li class="nav-item" id="roleDisplay" style="display:none;"><span class="navbar-text">Role: <span id="roleText"></span></span></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <!-- Error Banner (Hidden) -->
      <div id="errorBanner" class="alert alert-warning" style="display:none;">
          <strong>Partial Load:</strong> <span id="errorMsg">Using cached dataâ€”API temporarily unavailable.</span>
          <button type="button" class="btn-close float-end" onclick="document.getElementById('errorBanner').style.display='none'"></button>
        </div>
        <div class="card">
          <div class="card-header text-center"><h2 id="empName">Loading your profile...</h2></div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6"><p><strong>Email:</strong> <span id="empEmail">Loading...</span></p></div>
              <div class="col-md-6"><p><strong>Department:</strong> <span id="empDept">Loading...</span></p></div>
              <div class="col-md-6"><p><strong>Joined:</strong> <span id="empDate">Loading...</span></p></div>
              <div class="col-md-6"><p><strong>Username:</strong> <span id="empUser">Loading...</span></p></div>
              <div class="col-md-6"><p><strong>Role:</strong> <span id="empRole">Loading...</span></p></div>
            </div>
            <div class="d-flex justify-content-center gap-2 mt-3">
              <a href="/employees" class="btn btn-secondary">Back</a>
              <a id="editLink" href="#" class="btn btn-primary" style="display:none;">Edit</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = '/api';
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const userId = localStorage.getItem('userId');
    const username = localStorage.getItem('username') || 'Unknown';  // NEW: Store during login
    const name = localStorage.getItem('name') || 'Your Name';  // NEW: Fallback
    const email = localStorage.getItem('email') || 'your@email.com';  // NEW
    const department = localStorage.getItem('department') || 'Your Dept';  // NEW
    
    if (!token) { 
      console.log('No token - redirecting'); 
      window.location.href = '/login'; 
     
	  

    }
    document.getElementById('loginLi').style.display = 'none';
    document.getElementById('logoutLi').style.display = 'list-item';
    document.getElementById('roleDisplay').style.display = 'list-item';
    document.getElementById('roleText').textContent = role.charAt(0).toUpperCase() + role.slice(1);
    
    function logout() { localStorage.clear(); window.location.href = '/login'; }
    
    // IMMEDIATE FALLBACK DISPLAY (Basics from localStorage)
    function showFallback() {
      console.log('Showing fallback data');
      document.getElementById('empName').textContent = name;
      document.getElementById('empEmail').textContent = email;
      document.getElementById('empDept').textContent = department;
      document.getElementById('empDate').textContent = 'Recent';  // Or fetch date if stored
      document.getElementById('empUser').textContent = username;
      document.getElementById('empRole').textContent = role.charAt(0).toUpperCase() + role.slice(1);
      if (role === 'admin') {
        document.getElementById('editLink').href = `/edit?id=${localStorage.getItem('employeeId') || ''}`;
        document.getElementById('editLink').style.display = 'inline-block';
      }
      document.getElementById('errorBanner').style.display = 'block';
    }
    showFallback();  // SHOW SOMETHING RIGHT AWAY!
    
    // Load full data (with new server support)
    let empId;
    const urlParams = new URLSearchParams(window.location.search);
    empId = urlParams.get('id') || localStorage.getItem('employeeId');
    console.log('empId:', empId);
    
    function loadFullData(id) {
      fetch(`${API_BASE}/employees/${id}`, { 
        headers: { 'Authorization': `Bearer ${token}` } 
      })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
        .then(emp => {
          if (emp.error) throw new Error(emp.error);
          console.log('Full data loaded:', emp);
          // Override fallback with API data
          document.getElementById('empName').textContent = emp.name;
          document.getElementById('empEmail').textContent = emp.email;
          document.getElementById('empDept').textContent = emp.department;
          document.getElementById('empDate').textContent = new Date(emp.createdAt).toLocaleDateString();
          if (emp.userId) {
            document.getElementById('empUser').textContent = emp.userId.username;
            document.getElementById('empRole').textContent = emp.userId.role.charAt(0).toUpperCase() + emp.userId.role.slice(1);
          }
          document.getElementById('errorBanner').style.display = 'none';  // Hide if success
        })
        .catch(err => {
          console.error('Full load failed:', err);
          // Keep fallback visible
        });
    }
    
    // Auto-fetch own if no empId
    if (!empId) {
      console.log('Fetching own profile via ?userId=');
      fetch(`${API_BASE}/employees?userId=${userId}&page=1&limit=1`, { 
        headers: { 'Authorization': `Bearer ${token}` } 
      })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (data.employees && data.employees.length > 0) {
            empId = data.employees[0]._id;
            localStorage.setItem('employeeId', empId);  // Cache it
            loadFullData(empId);
          } else {
            console.warn('No own employee found');
          }
        })
        .catch(err => console.error('Auto-fetch failed:', err));
    } else {
      loadFullData(empId);  // Use provided ID
    }
    
    // 10s timeout: Ensure no hang
    setTimeout(() => {
      if (document.getElementById('empEmail').textContent === 'Loading...') {
        console.log('Timeout - keeping fallback');
      }
    }, 10000);
  </script>
</body>
</html>
